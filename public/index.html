<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 尾牙大亂鬥</title>
    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; text-align: center; background: #222; color: #fff; overflow: hidden; touch-action: manipulation; }
        .page { display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; width: 100%; position: absolute; top:0; left:0; background: #222; }
        
        /* 通用按鈕 */
        .btn { padding: 15px 30px; font-size: 1.5rem; border-radius: 15px; border: none; cursor: pointer; margin: 10px; font-weight: bold; width: 80%; }
        .btn-green { background: #2ed573; color: white; }
        .btn-red { background: #ff4757; color: white; }
        .btn-blue { background: #1e90ff; color: white; }
        .btn-grey { background: #747d8c; color: white; }
        
        input { padding: 15px; font-size: 1.5rem; border-radius: 10px; width: 70%; text-align: center; margin-bottom: 20px; }

        /* 選隊伍頁 */
        #teamSelectPage { flex-direction: row; }
        .team-split { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; cursor: pointer; }
        .bg-red { background: #ff4757; }
        .bg-blue { background: #1e90ff; }

        /* 遊戲頁 */
        #gamePage { background: #222; }
        #clickBtn { width: 260px; height: 260px; border-radius: 50%; border: 8px solid rgba(255,255,255,0.5); font-size: 2rem; background: #ffa502; color: #fff; box-shadow: 0 0 30px #ffa502; font-weight: 900; }
        #clickBtn:active { transform: scale(0.95); }
        #clickBtn:disabled { background: #535c68; box-shadow: none; border-color: #333; }
        
        /* 勝利選擇頁 */
        #winChoicePage { background: #ffa502; }
        #winChoicePage h1 { font-size: 3rem; margin-bottom: 20px; text-shadow: 0 0 10px black; }
        
        /* 訊息文字 */
        .info-text { font-size: 1.5rem; margin: 20px; line-height: 1.5; }
        .warning-toast { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: rgba(255,0,0,0.9); padding: 15px; border-radius: 10px; display: none; z-index: 999; }
    </style>
</head>
<body>
    
    <div id="toast" class="warning-toast">隊伍人數不平衡，請重新分配！</div>

    <div id="loginPage" class="page" style="display: flex;">
        <h1>尾牙大逃殺</h1>
        <p>生存遊戲，強者生存</p>
        <input type="text" id="username" placeholder="請輸入真實姓名" />
        <button class="btn btn-green" onclick="doLogin()">進入戰場</button>
    </div>

    <div id="teamSelectPage" class="page">
        <div class="team-split bg-red" onclick="joinTeam('A')">紅隊<br>(加入)</div>
        <div class="team-split bg-blue" onclick="joinTeam('B')">藍隊<br>(加入)</div>
    </div>

    <div id="waitingPage" class="page">
        <h2 id="waitTeamName"></h2>
        <div class="info-text">等待比賽開始...</div>
        <button class="btn btn-grey" onclick="reselect()">重選隊伍</button>
    </div>

    <div id="gamePage" class="page">
        <h2 id="timerDisplay" style="font-size: 4rem; color: #f1c40f;">30</h2>
        <button id="clickBtn" onclick="sendClick()" disabled>連擊!!</button>
    </div>

    <div id="winChoicePage" class="page">
        <h1>VICTORY!</h1>
        <div class="info-text">恭喜晉級！<br>你是本局勝利者</div>
        <div class="info-text">是否繼續參加下一場？</div>
        <button class="btn btn-green" onclick="answerContinue(true)">是 (繼續戰鬥)</button>
        <button class="btn btn-red" onclick="answerContinue(false)">否 (自願放棄)</button>
    </div>

    <div id="loserPage" class="page" style="background: #2f3542;">
        <h1 style="color: #747d8c;">ELIMINATED</h1>
        <div class="info-text">很遺憾，您已被淘汰。<br>請在台下為倖存者加油！</div>
    </div>

    <div id="forfeitPage" class="page" style="background: #2f3542;">
        <h1>已放棄</h1>
        <div class="info-text">您已自願放棄參賽資格。<br>謝謝參與！</div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myTeam = '';

        // 防止手機雙擊縮放
        document.addEventListener('gesturestart', function (e) { e.preventDefault(); });

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'flex';
        }

        function doLogin() {
            const name = document.getElementById('username').value.trim();
            if(!name) return alert('請輸入姓名');
            socket.emit('login', name);
        }

        socket.on('loginSuccess', () => {
            showPage('teamSelectPage');
        });

        function joinTeam(team) {
            myTeam = team;
            socket.emit('joinTeam', team);
        }

        function reselect() {
            showPage('teamSelectPage');
        }

        // 伺服器確認加入後，進入等待畫面
        socket.on('waitingForStart', (team) => {
            showPage('waitingPage');
            document.getElementById('waitTeamName').innerText = (team === 'A') ? "我是紅隊" : "我是藍隊";
            document.getElementById('waitTeamName').style.color = (team === 'A') ? "#ff4757" : "#1e90ff";
        });

        // 需求(5) 隊伍不平衡提示
        socket.on('teamUnbalanced', () => {
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
            
            // 如果在等待頁，允許他們重選
            if(document.getElementById('waitingPage').style.display === 'flex') {
                // 這裡可以選擇強制跳回，或者讓使用者自己按「重選」
                // 為了體驗，我們只顯示 Toast 警告
            }
        });

        // 遊戲開始
        socket.on('gameStart', (duration) => {
            showPage('gamePage');
            document.getElementById('clickBtn').disabled = false;
            document.getElementById('gamePage').style.background = (myTeam==='A') ? '#ff4757' : '#1e90ff';
            
            let timeLeft = duration;
            document.getElementById('timerDisplay').innerText = timeLeft;
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if(timeLeft <= 0) clearInterval(timer);
            }, 1000);
        });

        function sendClick() {
            if (navigator.vibrate) navigator.vibrate(40);
            socket.emit('click', myTeam);
        }

        // 回合結果通知
        socket.on('roundResult', (data) => {
            if (data.result === 'win') {
                showPage('winChoicePage'); // 顯示 Yes/No
            } else if (data.result === 'lose') {
                showPage('loserPage'); // 顯示淘汰
            } else {
                // 平手，直接回到等待或選隊 (依規則定，這邊假設平手晉級)
                alert('平手！全員晉級！');
                answerContinue(true); 
            }
        });

        // 需求(3) 玩家選擇是否繼續
        function answerContinue(choice) {
            socket.emit('continueNextRound', choice);
        }

        // 伺服器准許重新選隊
        socket.on('reSelectTeam', () => {
            showPage('teamSelectPage');
        });

        // 顯示放棄頁面
        socket.on('showForfeit', () => {
            showPage('forfeitPage');
        });
        
        // 被伺服器強制踢出 (例如非法操作)
        socket.on('forceEliminate', () => {
            showPage('loserPage');
        });

    </script>
</body>
</html>