<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>2025 尾牙戰況</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { background: #1e272e; color: #fff; font-family: "Arial Black", sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; }
        
        /* 標題 */
        #header { font-size: 3rem; text-align: center; padding: 20px; color: #fbc531; text-shadow: 0 0 20px #fbc531; letter-spacing: 5px; }
        
        /* 倒數計時 */
        #timer-box { font-size: 8rem; text-align: center; margin: 10px 0; color: #fff; text-shadow: 0 0 30px rgba(255,255,255,0.5); }
        .urgent { color: #ff3f34; text-shadow: 0 0 50px #ff3f34 !important; transform: scale(1.2); transition: 0.2s; }

        /* 拔河條 */
        #battle-field { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 0 50px; }
        .bar-container { width: 100%; height: 150px; background: #353b48; border-radius: 75px; overflow: hidden; border: 8px solid #dcdde1; display: flex; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        
        #bar-A { background: linear-gradient(90deg, #c23616, #e84118); width: 50%; transition: width 0.1s linear; display: flex; align-items: center; justify-content: flex-start; }
        #bar-B { background: linear-gradient(90deg, #0097e6, #00a8ff); width: 50%; transition: width 0.1s linear; display: flex; align-items: center; justify-content: flex-end; }
        
        .score-num { font-size: 4rem; margin: 0 30px; z-index: 2; white-space: nowrap; text-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .center-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 6px; background: #fff; transform: translateX(-50%); z-index: 5; box-shadow: 0 0 15px white; }

        /* 贏家彈窗 */
        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.92); z-index: 100; display: none; 
            flex-direction: column; justify-content: center; align-items: center;
            animation: fadeIn 0.5s;
        }
        #win-title { font-size: 6rem; margin-bottom: 20px; }
        #win-score { font-size: 3rem; color: #dcdde1; }
        .win-red { color: #e84118; text-shadow: 0 0 60px #e84118; }
        .win-blue { color: #0097e6; text-shadow: 0 0 60px #0097e6; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 提示字 */
        #footer { position: absolute; bottom: 10px; right: 20px; color: #7f8fa6; font-size: 14px; font-family: Arial; }
    </style>
</head>
<body>
    <div id="header">2025 資訊部大亂鬥</div>
    <div id="timer-box">30</div>

    <div id="battle-field">
        <div class="bar-container">
            <div id="bar-A"><span class="score-num" id="scoreA">0</span></div>
            <div id="bar-B"><span class="score-num" id="scoreB">0</span></div>
            <div class="center-line"></div>
        </div>
    </div>

    <div id="overlay">
        <div id="win-title">WINNER</div>
        <div id="win-score">0 : 0</div>
    </div>

    <div id="footer">按鍵盤 [S] 開始 | 按 [R] 重置</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const timerBox = document.getElementById('timer-box');
        const overlay = document.getElementById('overlay');
        const winTitle = document.getElementById('win-title');
        const winScore = document.getElementById('win-score');
        
        let timerInterval;

        socket.on('updateScore', (state) => {
            const total = state.teamA + state.teamB;
            document.getElementById('scoreA').innerText = state.teamA;
            document.getElementById('scoreB').innerText = state.teamB;
            
            let percentA = 50;
            if (total > 0) percentA = (state.teamA / total) * 100;
            
            document.getElementById('bar-A').style.width = percentA + '%';
            document.getElementById('bar-B').style.width = (100 - percentA) + '%';
        });

        socket.on('gameStart', (duration) => {
            overlay.style.display = 'none';
            let timeLeft = duration;
            timerBox.innerText = timeLeft;
            timerBox.className = ''; 

            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerBox.innerText = timeLeft;
                if (timeLeft <= 5) timerBox.className = 'urgent'; // 最後5秒變紅
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerBox.innerText = "TIME UP";
                }
            }, 1000);
        });

        socket.on('gameOver', (result) => {
            clearInterval(timerInterval);
            
            // 顯示結果
            let text = "平手";
            winTitle.className = "";
            
            if (result.winner === 'A') {
                text = "紅隊獲勝！";
                winTitle.classList.add('win-red');
            } else if (result.winner === 'B') {
                text = "藍隊獲勝！";
                winTitle.classList.add('win-blue');
            }

            winTitle.innerText = text;
            winScore.innerText = `${result.scoreA} : ${result.scoreB}`;
            overlay.style.display = 'flex';

            // 觸發12禮炮
            fire12Salutes(result.winner);
        });

        socket.on('resetGame', () => {
            overlay.style.display = 'none';
            timerBox.innerText = "30";
            timerBox.className = "";
            clearInterval(timerInterval);
        });

        // 鍵盤控制
        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 's') socket.emit('adminAction', 'start');
            if(e.key.toLowerCase() === 'r') socket.emit('adminAction', 'reset');
        });

        // --- 12禮炮特效函式 ---
        function fire12Salutes(winner) {
            let count = 0;
            let colors = (winner === 'A') ? ['#e84118', '#ffffff'] : ['#0097e6', '#ffffff'];
            if (winner === 'DRAW') colors = ['#fbc531', '#ffffff'];

            const interval = setInterval(() => {
                count++;
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6, x: Math.random() * 0.6 + 0.2 }, // 隨機位置
                    colors: colors,
                    zIndex: 200
                });

                if (count >= 12) clearInterval(interval);
            }, 300); // 每0.3秒發射一次
        }
    </script>
</body>
</html>