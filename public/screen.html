<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æˆ°æ³é¡¯ç¤ºæ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { background: #1e272e; color: #fff; font-family: "Microsoft JhengHei", 'Arial Black', sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; }
        
        #header { font-size: 2.5rem; text-align: center; padding: 15px; color: #ffd700; text-shadow: 0 0 10px #ffd700; background: rgba(0,0,0,0.3); z-index: 10; }

        /* ä¸»ä½ˆå±€ï¼šå·¦åå–® | ä¸­æˆ°å ´ | å³åå–® */
        #main-container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* å…©å´åå–®åˆ—è¡¨ */
        .player-list { width: 20%; padding: 10px; overflow-y: auto; background: rgba(0,0,0,0.2); }
        .player-list h3 { text-align: center; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #fff; }
        .list-content { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
        .p-name { padding: 4px 8px; border-radius: 4px; font-size: 1.2rem; background: rgba(255,255,255,0.1); animation: popIn 0.3s ease; }
        
        #list-A { border-right: 2px solid #ff4757; }
        #list-A h3 { color: #ff4757; }
        #list-B { border-left: 2px solid #1e90ff; }
        #list-B h3 { color: #1e90ff; }

        /* ä¸­é–“æˆ°å ´ */
        #battle-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }

        /* å€’æ•¸è¨ˆæ™‚ */
        #timer { font-size: 10rem; font-weight: bold; text-shadow: 0 0 30px rgba(255,255,255,0.5); margin-bottom: 20px; transition: color 0.2s; }
        .urgent { color: #ff3f34; transform: scale(1.1); text-shadow: 0 0 50px red !important; }

        /* æ‹”æ²³æ¢ */
        .bar-container { width: 90%; height: 120px; background: #333; border-radius: 60px; position: relative; overflow: hidden; border: 6px solid #555; display: flex; box-shadow: 0 10px 30px black; }
        #bar-A { background: #ff4757; width: 50%; display: flex; align-items: center; justify-content: flex-start; transition: width 0.1s linear; }
        #bar-B { background: #1e90ff; width: 50%; display: flex; align-items: center; justify-content: flex-end; transition: width 0.1s linear; }
        .score { font-size: 4rem; margin: 0 30px; white-space: nowrap; z-index: 2; text-shadow: 2px 2px 5px black; }
        
        /* è´å®¶çµç®—å±¤ */
        #winner-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 100; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            animation: fadeIn 0.5s;
        }
        #win-title { font-size: 5rem; margin-bottom: 10px; }
        #win-detail { font-size: 2rem; color: #ccc; margin-bottom: 30px; }
        #win-names-box { width: 80%; max-height: 40vh; overflow-y: auto; text-align: center; border: 2px solid #555; padding: 20px; border-radius: 15px; background: rgba(255,255,255,0.05); }
        .winner-name-tag { display: inline-block; font-size: 1.5rem; margin: 5px 10px; color: #ffd700; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* éš±è—æ§åˆ¶éˆ• */
        #controls { position: absolute; bottom: 5px; right: 5px; opacity: 0.2; }
    </style>
</head>
<body>
    <div id="header">2025 å°¾ç‰™é›²ç«¯æ‹”æ²³ - èª°æ˜¯ç¸½å† è»</div>
    
    <div id="main-container">
        <div id="list-A" class="player-list">
            <h3>ç´…éšŠæˆ°å‹</h3>
            <div id="content-A" class="list-content"></div>
        </div>

        <div id="battle-area">
            <div id="timer">30</div>
            
            <div class="bar-container">
                <div id="bar-A"><span class="score" id="scoreA">0</span></div>
                <div id="bar-B"><span class="score" id="scoreB">0</span></div>
                <div style="position: absolute; left: 50%; height: 100%; width: 4px; background: white; transform: translateX(-50%); z-index: 5;"></div>
            </div>
        </div>

        <div id="list-B" class="player-list">
            <h3>è—éšŠæˆ°å‹</h3>
            <div id="content-B" class="list-content"></div>
        </div>
    </div>

    <div id="winner-overlay">
        <div id="win-title">ç´…éšŠç²å‹</div>
        <div id="win-detail">æ¯”åˆ† 100 : 80</div>
        <h3>ğŸ† æ¦®è€€åå–® ğŸ†</h3>
        <div id="win-names-box"></div>
    </div>

    <div id="controls">æŒ‰ S é–‹å§‹ | æŒ‰ R é‡ç½®</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let timerInterval;

        // 1. æ›´æ–°åˆ†æ•¸èˆ‡æ‹”æ²³æ¢
        socket.on('updateScore', (state) => {
            document.getElementById('scoreA').innerText = state.teamA;
            document.getElementById('scoreB').innerText = state.teamB;

            const total = state.teamA + state.teamB;
            let percentA = 50;
            if (total > 0) percentA = (state.teamA / total) * 100;
            
            document.getElementById('bar-A').style.width = percentA + '%';
            document.getElementById('bar-B').style.width = (100 - percentA) + '%';
        });

        // 2. æ›´æ–°ç©å®¶åå–® (æ–°å¢)
        socket.on('updatePlayers', (players) => {
            renderList('content-A', players.A);
            renderList('content-B', players.B);
        });

        function renderList(elementId, names) {
            const container = document.getElementById(elementId);
            container.innerHTML = names.map(n => `<span class="p-name">${n}</span>`).join('');
            // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
            const parent = container.parentElement;
            parent.scrollTop = parent.scrollHeight;
        }

        // 3. éŠæˆ²é–‹å§‹å€’æ•¸
        socket.on('gameStart', (duration) => {
            document.getElementById('winner-overlay').style.display = 'none';
            let timeLeft = duration;
            const timerEl = document.getElementById('timer');
            timerEl.innerText = timeLeft;
            timerEl.classList.remove('urgent');

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                if (timeLeft <= 5) timerEl.classList.add('urgent');
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerEl.innerText = "TIME UP";
                }
            }, 1000);
        });

        // 4. éŠæˆ²çµæŸ + ç¦®ç‚® + åå–®
        socket.on('gameOver', (result) => {
            clearInterval(timerInterval);

            // è¨­å®šè´å®¶é¡¯ç¤º
            const title = document.getElementById('win-title');
            if (result.winner === 'A') {
                title.innerText = "ğŸ‰ ç´…éšŠç²å‹ï¼";
                title.style.color = "#ff4757";
            } else if (result.winner === 'B') {
                title.innerText = "ğŸ‰ è—éšŠç²å‹ï¼";
                title.style.color = "#1e90ff";
            } else {
                title.innerText = "ğŸ¤ å‹¢å‡åŠ›æ•µï¼";
                title.style.color = "#ffd700";
            }
            
            document.getElementById('win-detail').innerText = `æœ€çµ‚æ¯”åˆ† ${result.scoreA} : ${result.scoreB}`;
            
            // é¡¯ç¤ºè´å®¶åå–®
            document.getElementById('win-names-box').innerHTML = result.winnerNames.map(n => 
                `<span class="winner-name-tag">${n}</span>`
            ).join('');

            document.getElementById('winner-overlay').style.display = 'flex';

            // ç™¼å°„ 12 éŸ¿ç¦®ç‚®
            fire12Salutes(result.winner);
        });

        // 5. é‡ç½®
        socket.on('resetGame', () => {
            document.getElementById('winner-overlay').style.display = 'none';
            document.getElementById('timer').innerText = "30";
            renderList('content-A', []);
            renderList('content-B', []);
        });

        // éµç›¤ç›£è½
        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 's') socket.emit('adminAction', 'start');
            if(e.key.toLowerCase() === 'r') socket.emit('adminAction', 'reset');
        });

        // --- 12 éŸ¿ç¦®ç‚®ç‰¹æ•ˆ ---
        function fire12Salutes(winner) {
            let count = 0;
            let colors = (winner === 'A') ? ['#ff4757', '#ffffff'] : ['#1e90ff', '#ffffff'];
            if(winner === 'DRAW') colors = ['#ffd700', '#ffffff'];

            const interval = setInterval(() => {
                count++;
                confetti({
                    particleCount: 150,
                    spread: 80,
                    origin: { y: 0.6, x: Math.random() * 0.6 + 0.2 }, // éš¨æ©Ÿæ°´å¹³ä½ç½®
                    colors: colors,
                    zIndex: 200
                });

                if (count >= 12) clearInterval(interval);
            }, 300); // æ¯ 0.3 ç§’ä¸€ç™¼
        }
    </script>
</body>
</html>