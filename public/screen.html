<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>戰況顯示板</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { background: #1e272e; color: #fff; font-family: 'Arial Black', sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; }
        
        #header { font-size: 2.5rem; text-align: center; padding: 20px; color: #fbc531; text-shadow: 0 0 20px #fbc531; letter-spacing: 5px; z-index: 5; }
        
        #timer-container { font-size: 8rem; text-align: center; margin-bottom: 10px; color: #fff; text-shadow: 0 0 30px rgba(255,255,255,0.8); z-index: 5; transition: color 0.2s; }
        .urgent { color: #ff3f34 !important; text-shadow: 0 0 50px #ff3f34 !important; transform: scale(1.2); }

        #battle-field { flex: 1; display: flex; flex-direction: column; justify-content: center; position: relative; padding: 0 50px; }
        
        .bar-container { width: 100%; height: 150px; background: #2f3640; border-radius: 75px; overflow: hidden; border: 8px solid #dcdde1; display: flex; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        #bar-A { background: linear-gradient(90deg, #c23616, #e84118); width: 50%; transition: width 0.1s linear; display: flex; align-items: center; justify-content: flex-start; }
        #bar-B { background: linear-gradient(90deg, #0097e6, #00a8ff); width: 50%; transition: width 0.1s linear; display: flex; align-items: center; justify-content: flex-end; }
        
        .score-text { font-size: 5rem; margin: 0 40px; white-space: nowrap; z-index: 2; text-shadow: 3px 3px 6px rgba(0,0,0,0.6); }
        .center-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 8px; background: #fff; transform: translateX(-50%); z-index: 10; box-shadow: 0 0 20px white; }

        #winner-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 100; 
            display: none; flex-direction: column; justify-content: center; align-items: center;
            animation: fadeIn 0.5s;
        }
        #winner-text { font-size: 6rem; color: #fbc531; margin-bottom: 20px; text-shadow: 0 0 50px #fbc531; }
        #winner-detail { font-size: 3rem; color: #fff; }
        .winner-red { color: #e84118 !important; text-shadow: 0 0 50px #e84118 !important; }
        .winner-blue { color: #0097e6 !important; text-shadow: 0 0 50px #0097e6 !important; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 新增：控制面板 */
        #controls { position: absolute; bottom: 20px; right: 20px; z-index: 200; display: flex; gap: 10px; }
        .ctrl-btn { padding: 10px 20px; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
        .btn-start { background: #44bd32; color: white; }
        .btn-reset { background: #c23616; color: white; }
        .btn-start:active, .btn-reset:active { transform: scale(0.95); }

    </style>
</head>
<body>
    <div id="header">2025 資訊部：雲端拔河大決戰</div>
    
    <div id="timer-container">準備開始</div>

    <div id="battle-field">
        <div class="bar-container">
            <div id="bar-A"><span class="score-text" id="scoreA">0</span></div>
            <div id="bar-B"><span class="score-text" id="scoreB">0</span></div>
            <div class="center-line"></div>
        </div>
    </div>

    <div id="winner-overlay">
        <div id="winner-text">WINNER!</div>
        <div id="winner-detail">比分 100 : 90</div>
        <button class="ctrl-btn btn-reset" onclick="adminAction('reset')" style="margin-top:30px">重新一局</button>
    </div>

    <div id="controls">
        <button class="ctrl-btn btn-start" onclick="adminAction('start')">▶ 開始遊戲 (S)</button>
        <button class="ctrl-btn btn-reset" onclick="adminAction('reset')">⟳ 重置 (R)</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const timerEl = document.getElementById('timer-container');
        const overlay = document.getElementById('winner-overlay');
        const winnerText = document.getElementById('winner-text');
        const winnerDetail = document.getElementById('winner-detail');

        let timerInterval;

        function adminAction(action) {
            socket.emit('adminAction', action);
        }

        socket.on('updateScore', (state) => {
            const total = state.teamA + state.teamB;
            document.getElementById('scoreA').innerText = state.teamA;
            document.getElementById('scoreB').innerText = state.teamB;

            let percentA = 50;
            if (total > 0) percentA = (state.teamA / total) * 100;
            
            document.getElementById('bar-A').style.width = percentA + '%';
            document.getElementById('bar-B').style.width = (100 - percentA) + '%';
        });

        socket.on('gameStart', (duration) => {
            overlay.style.display = 'none';
            let timeLeft = duration;
            timerEl.innerText = timeLeft;
            timerEl.className = ''; 

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                if (timeLeft <= 5) timerEl.classList.add('urgent');
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerEl.innerText = "TIME UP";
                }
            }, 1000);
        });

        socket.on('gameOver', (result) => {
            clearInterval(timerInterval);
            let winnerName = "平手";
            winnerText.className = "";

            if (result.winner === 'A') {
                winnerName = "紅隊 獲勝！";
                winnerText.classList.add('winner-red');
            } else if (result.winner === 'B') {
                winnerName = "藍隊 獲勝！";
                winnerText.classList.add('winner-blue');
            } else {
                winnerName = "平分秋色！";
            }

            winnerText.innerText = winnerName;
            winnerDetail.innerText = `${result.scoreA} : ${result.scoreB}`;
            overlay.style.display = 'flex';
            fireSalute(result.winner);
        });

        socket.on('resetGame', () => {
            overlay.style.display = 'none';
            timerEl.innerText = "準備開始";
            timerEl.className = "";
            clearInterval(timerInterval);
        });

        document.addEventListener('keydown', (e) => {
            if(e.key.toLowerCase() === 's') adminAction('start');
            if(e.key.toLowerCase() === 'r') adminAction('reset');
        });

        function fireSalute(winner) {
            const duration = 3000;
            let colors = ['#ffffff', '#ffd700'];
            if (winner === 'A') colors = ['#e84118', '#c23616', '#ffffff'];
            if (winner === 'B') colors = ['#0097e6', '#00a8ff', '#ffffff'];

            let count = 0;
            const saluteInterval = setInterval(() => {
                count++;
                confetti({
                    particleCount: 150,
                    spread: 80,
                    origin: { y: 0.6, x: Math.random() * 0.4 + 0.3 },
                    colors: colors,
                    zIndex: 200
                });
                if (count >= 12) clearInterval(saluteInterval);
            }, 300);
        }
    </script>
</body>
</html>