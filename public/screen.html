<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>2025 å°¾ç‰™å¤§äº‚é¬¥ - æˆ°æ³ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { background: #1e272e; color: #fff; font-family: "Microsoft JhengHei", Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; margin: 0; overflow: hidden; }
        
        /* ç©¿é€ç‰¹æ•ˆå±¤ï¼Œé¿å…æ“‹ä½æŒ‰éˆ• */
        canvas { pointer-events: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; }

        #header { font-size: 2rem; text-align: center; padding: 10px; background: rgba(0,0,0,0.5); display: flex; justify-content: space-between; align-items: center; }
        #round-info { color: #fbc531; font-weight: bold; margin-left: 20px; font-size: 2.5rem; }
        #survivor-info { margin-right: 20px; font-size: 1.5rem; color: #00d2d3; }

        #main-stage { flex: 1; display: flex; position: relative; }
        
        .side-panel { width: 22%; background: rgba(0,0,0,0.2); padding: 10px; overflow-y: auto; display: flex; flex-direction: column; }
        .side-panel h2 { text-align: center; margin: 0 0 10px 0; border-bottom: 2px solid #fff; padding-bottom: 5px; }
        .name-tag { display: inline-block; padding: 5px 10px; margin: 3px; background: rgba(255,255,255,0.15); border-radius: 4px; font-size: 1.2rem; }
        
        #panel-A h2 { color: #ff4757; border-color: #ff4757; }
        #panel-B h2 { color: #1e90ff; border-color: #1e90ff; }

        #center-stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        #timer { font-size: 12rem; font-weight: bold; text-shadow: 0 0 30px rgba(255,255,255,0.5); z-index: 5; margin-bottom: 30px; }
        .timer-urgent { color: #ff3f34; animation: pulse 0.5s infinite; }

        .bar-box { width: 90%; height: 150px; background: #333; border-radius: 75px; border: 8px solid #555; position: relative; overflow: hidden; display: flex; box-shadow: 0 10px 50px #000; }
        #bar-A { background: #ff4757; height: 100%; width: 50%; display: flex; align-items: center; justify-content: flex-start; transition: width 0.1s linear; }
        #bar-B { background: #1e90ff; height: 100%; width: 50%; display: flex; align-items: center; justify-content: flex-end; transition: width 0.1s linear; }
        .score-text { font-size: 5rem; margin: 0 40px; z-index: 10; font-weight: bold; text-shadow: 3px 3px 5px rgba(0,0,0,0.8); }

        /* è¦†è“‹å±¤ */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.5s; }
        
        #overlay-title { font-size: 6rem; margin-bottom: 10px; text-shadow: 0 0 30px currentColor; }
        #overlay-subtitle { font-size: 2.5rem; color: #ccc; margin-bottom: 20px; }
        #winner-count { font-size: 3rem; color: #fbc531; margin-bottom: 20px; border: 2px solid #fbc531; padding: 10px 30px; border-radius: 50px; }
        
        #winner-list { width: 80%; max-height: 40vh; overflow-y: auto; text-align: center; }
        .win-name { color: #ffd700; font-size: 2rem; margin: 10px; display: inline-block; }

        #warning-box { position: absolute; top: 20%; background: #c0392b; padding: 20px 40px; border-radius: 10px; font-size: 2rem; display: none; z-index: 200; box-shadow: 0 0 50px red; }

        /* æŒ‰éˆ•æ¨£å¼ï¼šç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        .admin-btn { 
            position: relative; z-index: 1000;
            margin-top: 30px; padding: 15px 40px; font-size: 2rem; 
            background: #00cec9; color: black; border: none; border-radius: 10px; 
            cursor: pointer; font-weight: bold; box-shadow: 0 0 20px #00cec9; 
            transition: all 0.1s; 
        }
        .admin-btn:active { transform: scale(0.95); background: #81ecec; }
        .admin-btn:hover { background: #81ecec; }

        #controls-hint { position: absolute; bottom: 10px; right: 10px; opacity: 0.5; font-size: 1rem; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="header">
        <div id="round-info">ROUND 1</div>
        <div id="survivor-info">å­˜æ´»äººæ•¸: 0</div>
    </div>

    <div id="main-stage">
        <div id="panel-A" class="side-panel">
            <h2>ç´…éšŠ (<span id="count-A">0</span>)</h2>
            <div id="list-A"></div>
        </div>

        <div id="center-stage">
            <div id="warning-box">è­¦å‘Šè¨Šæ¯</div>
            <div id="timer">30</div>
            
            <div class="bar-box">
                <div id="bar-A"><span class="score-text" id="scoreA">0</span></div>
                <div id="bar-B"><span class="score-text" id="scoreB">0</span></div>
                <div style="position: absolute; left: 50%; height: 100%; width: 4px; background: white; transform: translateX(-50%); z-index: 5;"></div>
            </div>
        </div>

        <div id="panel-B" class="side-panel">
            <h2>è—éšŠ (<span id="count-B">0</span>)</h2>
            <div id="list-B"></div>
        </div>
    </div>

    <div id="overlay">
        <div id="overlay-title">WINNER</div>
        <div id="overlay-subtitle">æ¯”åˆ† 0 : 0</div>
        <div id="winner-count">å…± 0 äººæ™‰ç´š</div>
        <div id="winner-list"></div>
        
        <div id="next-action-area">
            <button id="nextBtn" class="admin-btn" onclick="triggerNextRound()">ä¸‹ä¸€å ´æ¯”è³½ (N)</button>
        </div>
    </div>

    <div id="controls-hint">å¿«é€Ÿéµ: [S] é–‹å§‹ | [N] ä¸‹ä¸€å ´ | [R] å…¨åŸŸé‡ç½®</div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let timerInterval;

        socket.on('updatePlayerList', (data) => {
            document.getElementById('survivor-info').innerText = `å­˜æ´»äººæ•¸: ${data.totalSurvivors}`;
            document.getElementById('round-info').innerText = `ROUND ${data.round}`;
            document.getElementById('count-A').innerText = data.A.length;
            document.getElementById('count-B').innerText = data.B.length;
            updateList('list-A', data.A);
            updateList('list-B', data.B);
        });

        function updateList(id, names) {
            const el = document.getElementById(id);
            el.innerHTML = names.map(n => `<span class="name-tag">${n}</span>`).join('');
            el.parentElement.scrollTop = el.parentElement.scrollHeight;
        }

        socket.on('updateScore', (score) => {
            document.getElementById('scoreA').innerText = score.a;
            document.getElementById('scoreB').innerText = score.b;
            const total = score.a + score.b;
            let percentA = 50;
            if (total > 0) percentA = (score.a / total) * 100;
            document.getElementById('bar-A').style.width = percentA + '%';
            document.getElementById('bar-B').style.width = (100 - percentA) + '%';
        });

        socket.on('gameStart', (duration) => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('warning-box').style.display = 'none';
            let timeLeft = duration;
            const timerEl = document.getElementById('timer');
            timerEl.innerText = timeLeft;
            timerEl.classList.remove('timer-urgent');

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                if(timeLeft <= 5) timerEl.classList.add('timer-urgent');
                if(timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerEl.innerText = "TIME UP";
                }
            }, 1000);
        });

        socket.on('roundOver', (data) => {
            clearInterval(timerInterval);
            const overlay = document.getElementById('overlay');
            const title = document.getElementById('overlay-title');
            const actionArea = document.getElementById('next-action-area');
            const nextBtn = document.getElementById('nextBtn');

            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            nextBtn.innerText = "ä¸‹ä¸€å ´æ¯”è³½ (N)";
            nextBtn.disabled = false;
            nextBtn.style.background = "#00cec9";

            overlay.style.display = 'flex';
            document.getElementById('overlay-subtitle').innerText = `æ¯”åˆ† ${data.scoreA} : ${data.scoreB}`;
            
            if (data.isUltimateWinner) {
                title.innerText = "ğŸ‘‘ æœ€çµ‚å¤§é€ƒæ®ºå† è» ğŸ‘‘";
                title.style.color = "#ffd700"; 
                actionArea.style.display = 'none'; 
            } else {
                actionArea.style.display = 'block'; 
                if (data.winnerTeam === 'A') {
                    title.innerText = "ç´…éšŠç²å‹";
                    title.style.color = "#ff4757";
                } else if (data.winnerTeam === 'B') {
                    title.innerText = "è—éšŠç²å‹";
                    title.style.color = "#1e90ff";
                } else {
                    title.innerText = "å¹³æ‰‹ (å…¨å“¡æ™‰ç´š)";
                    title.style.color = "#fff";
                }
            }

            document.getElementById('winner-count').innerText = `å…± ${data.survivorCount} äººæ™‰ç´š`;
            document.getElementById('winner-list').innerHTML = data.winnerNames.map(n => `<span class="win-name">${n}</span>`).join('');
            fireSalutes(data.winnerTeam);
        });

        socket.on('resetScreenForNextRound', (round) => {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('timer').innerText = "30";
            document.getElementById('scoreA').innerText = 0;
            document.getElementById('scoreB').innerText = 0;
            document.getElementById('bar-A').style.width = "50%";
            document.getElementById('bar-B').style.width = "50%";
        });

        socket.on('showWarning', (msg) => {
            const box = document.getElementById('warning-box');
            box.innerText = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        });
        
        socket.on('allForfeit', () => {
            const title = document.getElementById('overlay-title');
            title.innerText = "æ‰€æœ‰åƒè³½è€…çš†æ”¾æ£„";
            title.style.color = "#7f8fa6";
            document.getElementById('next-action-area').style.display = 'none';
            document.getElementById('overlay').style.display = 'flex';
        });

        function triggerNextRound() {
            // é»æ“Šå¾Œçµ¦äºˆè¦–è¦ºå›é¥‹ï¼Œé¿å…é‡è¤‡é»æ“Š
            const btn = document.getElementById('nextBtn');
            btn.innerText = "æº–å‚™ä¸­...";
            btn.style.background = "#7f8fa6";
            socket.emit('adminAction', 'nextRound');
        }

        window.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (key === 's') socket.emit('adminAction', 'start');
            if (key === 'n') triggerNextRound(); 
            if (key === 'r' && e.shiftKey) socket.emit('adminAction', 'resetAll'); 
        });

        function fireSalutes(winner) {
            let colors = ['#fff', '#ffd700'];
            if(winner === 'A') colors = ['#ff4757', '#fff'];
            if(winner === 'B') colors = ['#1e90ff', '#fff'];

            let count = 0;
            const interval = setInterval(() => {
                count++;
                confetti({
                    particleCount: 150,
                    spread: 80,
                    origin: { y: 0.6, x: Math.random() * 0.6 + 0.2 },
                    colors: colors,
                    zIndex: 200 
                });
                if(count >= 12) clearInterval(interval);
            }, 300);
        }
    </script>
</body>
</html>